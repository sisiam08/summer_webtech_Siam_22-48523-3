<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - Shop Owner Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/shop_owner.css">
</head>
<body class="shop-owner">
    <div class="shop-owner-sidebar">
        <div class="brand">
            Shop Dashboard
        </div>
        <div class="menu">
            <a href="index.html" class="menu-item">
                <i class="material-icons">dashboard</i> <span>Dashboard</span>
            </a>
            <a href="products.html" class="menu-item">
                <i class="material-icons">inventory</i> <span>Products</span>
            </a>
            <a href="orders.html" class="menu-item active">
                <i class="material-icons">shopping_cart</i> <span>Orders</span>
            </a>
            <a href="reports.html" class="menu-item">
                <i class="material-icons">bar_chart</i> <span>Reports</span>
            </a>
            <a href="profile.html" class="menu-item">
                <i class="material-icons">store</i> <span>Shop Profile</span>
            </a>
        </div>
    </div>

    <div class="shop-owner-content">
        <div class="shop-owner-header">
            <h2>Manage Orders</h2>
            <div class="user-info">
                <div class="dropdown">
                    <span id="shop-owner-name">Shop Owner</span>
                    <i class="material-icons">arrow_drop_down</i>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="#" id="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions-bar">
            <div class="search-box">
                <input type="text" id="search-orders" placeholder="Search by order ID or customer name...">
                <i class="material-icons">search</i>
            </div>
            <div class="filters">
                <select id="status-filter">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <select id="date-filter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>

        <div class="data-table-container">
            <table class="data-table" id="orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Orders will be populated by JavaScript -->
                </tbody>
            </table>
            <div class="pagination" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Order Status</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Update status for Order #<span id="order-number"></span></p>
                <div class="form-group">
                    <label for="order-status">Status</label>
                    <select id="order-status" class="form-control">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="cancel-status">Cancel</button>
                <button class="btn primary" id="confirm-status">Update Status</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let ordersPerPage = 10;
        let currentOrderId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if shop owner is logged in
            fetch('../php/shop_owner/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'shop_owner') {
                        window.location.href = 'login.html';
                    } else {
                        document.getElementById('shop-owner-name').textContent = data.name;
                        
                        // Load orders
                        loadOrders();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = 'login.html';
                });
        });

        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('../php/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
            });
            
            // Search orders
            document.getElementById('search-orders').addEventListener('input', function() {
                currentPage = 1;
                loadOrders();
            });
            
            // Filter by status
            document.getElementById('status-filter').addEventListener('change', function() {
                currentPage = 1;
                loadOrders();
            });
            
            // Filter by date
            document.getElementById('date-filter').addEventListener('change', function() {
                currentPage = 1;
                loadOrders();
            });
            
            // Modal functionality
            const modal = document.getElementById('status-modal');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancel-status');
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Close modal if clicked outside
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Status update confirmation
            document.getElementById('confirm-status').addEventListener('click', function() {
                if (currentOrderId) {
                    const status = document.getElementById('order-status').value;
                    updateOrderStatus(currentOrderId, status);
                }
            });
        }

        function loadOrders() {
            const searchQuery = document.getElementById('search-orders').value;
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            let url = `../php/shop_owner/get_orders.php?page=${currentPage}&limit=${ordersPerPage}`;
            
            if (searchQuery) {
                url += `&search=${encodeURIComponent(searchQuery)}`;
            }
            
            if (statusFilter) {
                url += `&status=${encodeURIComponent(statusFilter)}`;
            }
            
            if (dateFilter) {
                url += `&date=${encodeURIComponent(dateFilter)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading orders:', data.error);
                        return;
                    }
                    
                    renderOrders(data.orders);
                    renderPagination(data.totalOrders);
                })
                .catch(error => console.error('Error loading orders:', error));
        }

        function renderOrders(orders) {
            const tableBody = document.querySelector('#orders-table tbody');
            tableBody.innerHTML = '';
            
            if (orders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="7" class="text-center">No orders found</td>';
                tableBody.appendChild(emptyRow);
                return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                
                // Create status badge
                let statusBadge;
                switch (order.status) {
                    case 'pending':
                        statusBadge = '<span class="badge warning">Pending</span>';
                        break;
                    case 'processing':
                        statusBadge = '<span class="badge info">Processing</span>';
                        break;
                    case 'shipped':
                        statusBadge = '<span class="badge primary">Shipped</span>';
                        break;
                    case 'delivered':
                        statusBadge = '<span class="badge success">Delivered</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="badge danger">Cancelled</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge secondary">' + order.status + '</span>';
                }
                
                row.innerHTML = `
                    <td>${order.order_number}</td>
                    <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.item_count} items</td>
                    <td>$${parseFloat(order.total_amount).toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td class="actions">
                        <a href="order-details.html?id=${order.id}" class="btn icon primary">
                            <i class="material-icons">visibility</i>
                        </a>
                        <button class="btn icon info update-status" data-id="${order.id}" data-number="${order.order_number}" data-status="${order.status}">
                            <i class="material-icons">update</i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to update status buttons
            document.querySelectorAll('.update-status').forEach(button => {
                button.addEventListener('click', function() {
                    currentOrderId = this.getAttribute('data-id');
                    const orderNumber = this.getAttribute('data-number');
                    const currentStatus = this.getAttribute('data-status');
                    
                    document.getElementById('order-number').textContent = orderNumber;
                    document.getElementById('order-status').value = currentStatus;
                    
                    openModal();
                });
            });
        }

        function renderPagination(totalOrders) {
            totalPages = Math.ceil(totalOrders / ordersPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn pagination-btn' + (currentPage === 1 ? ' disabled' : '');
            prevBtn.innerHTML = '<i class="material-icons">chevron_left</i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadOrders();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'btn pagination-btn' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    loadOrders();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn pagination-btn' + (currentPage === totalPages ? ' disabled' : '');
            nextBtn.innerHTML = '<i class="material-icons">chevron_right</i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadOrders();
                }
            });
            pagination.appendChild(nextBtn);
        }

        function openModal() {
            document.getElementById('status-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('status-modal').style.display = 'none';
            currentOrderId = null;
        }

        function updateOrderStatus(orderId, status) {
            fetch('../php/shop_owner/update_order_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `id=${orderId}&status=${status}`
            })
                .then(response => response.json())
                .then(data => {
                    closeModal();
                    
                    if (data.success) {
                        // Show success notification
                        alert('Order status updated successfully');
                        
                        // Reload orders
                        loadOrders();
                    } else {
                        // Show error notification
                        alert('Error updating order status: ' + data.error);
                    }
                })
                .catch(error => {
                    closeModal();
                    console.error('Error updating order status:', error);
                    alert('An error occurred while updating the order status');
                });
        }
    </script>
</body>
</html>
