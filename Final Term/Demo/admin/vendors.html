<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting to Vendors</title>
    <script>
        // Redirect to the PHP version of the vendors page
        window.location.href = 'vendors.php';
    </script>
</head>
<body>
    <h1>Redirecting to Vendors...</h1>
    <p>If you are not redirected automatically, <a href="vendors.php">click here</a>.</p>
</body>
</html>tml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendors Management - Online Grocery Store</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body class="admin">
    <div class="admin-sidebar">
        <div class="brand">
            Grocery Admin
        </div>
        <div class="menu">
            <a href="index.html" class="menu-item">
                <i class="material-icons">dashboard</i> Dashboard
            </a>
            <a href="products.html" class="menu-item">
                <i class="material-icons">inventory</i> Products
            </a>
            <a href="categories.html" class="menu-item">
                <i class="material-icons">category</i> Categories
            </a>
            <a href="orders.html" class="menu-item">
                <i class="material-icons">shopping_cart</i> Orders
            </a>
            <a href="users.html" class="menu-item">
                <i class="material-icons">people</i> Users
            </a>
            <a href="vendors.html" class="menu-item active">
                <i class="material-icons">store</i> Vendors
            </a>
            <a href="settings.html" class="menu-item">
                <i class="material-icons">settings</i> Settings
            </a>
        </div>
    </div>

    <div class="admin-content">
        <div class="admin-header">
            <h2>Vendors Management</h2>
            <div class="user-info">
                <div class="dropdown">
                    <span id="admin-username">Admin</span>
                    <i class="material-icons">arrow_drop_down</i>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="#" id="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-body">
            <div class="action-bar">
                <button id="add-vendor-btn" class="btn primary"><i class="material-icons">add</i> Add New Vendor</button>
                
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search vendors...">
                        <button id="search-btn"><i class="material-icons">search</i></button>
                    </div>
                    
                    <div class="filter-box">
                        <select id="status-filter">
                            <option value="">All Status</option>
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table" id="vendors-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Products</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
                
                <div class="pagination">
                    <button id="prev-page" class="btn secondary"><i class="material-icons">navigate_before</i></button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" class="btn secondary"><i class="material-icons">navigate_next</i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Form Modal -->
    <div id="vendor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Vendor</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="vendor-form">
                    <input type="hidden" id="vendor-id">
                    <div class="form-group">
                        <label for="vendor-name">Vendor Name:</label>
                        <input type="text" id="vendor-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="vendor-email">Email:</label>
                        <input type="email" id="vendor-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="vendor-phone">Phone:</label>
                        <input type="text" id="vendor-phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="vendor-address">Address:</label>
                        <textarea id="vendor-address" name="address" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="vendor-description">Description:</label>
                        <textarea id="vendor-description" name="description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="vendor-commission">Commission Rate (%):</label>
                        <input type="number" id="vendor-commission" name="commission_rate" min="0" max="100" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="vendor-status">Status:</label>
                        <select id="vendor-status" name="is_active">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn secondary" id="cancel-btn">Cancel</button>
                        <button type="submit" class="btn primary" id="save-btn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vendor Details Modal -->
    <div id="vendor-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Vendor Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="vendor-details">
                    <div class="detail-row">
                        <span class="detail-label">Vendor ID:</span>
                        <span id="detail-id" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span id="detail-name" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span id="detail-email" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span id="detail-phone" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span id="detail-address" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Description:</span>
                        <span id="detail-description" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Commission Rate:</span>
                        <span id="detail-commission" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span id="detail-status" class="detail-value"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Joined On:</span>
                        <span id="detail-created" class="detail-value"></span>
                    </div>
                </div>

                <h4>Vendor Products</h4>
                <div class="vendor-products-container">
                    <table class="data-table" id="vendor-products-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Products will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this vendor? This action cannot be undone.</p>
                <div class="form-buttons">
                    <button type="button" class="btn secondary" id="cancel-delete-btn">Cancel</button>
                    <button type="button" class="btn danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if admin is logged in
            fetch('../php/check_admin.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAdmin) {
                        window.location.href = 'login.html';
                    } else {
                        document.getElementById('admin-username').textContent = data.name;
                        // Load vendors after successful authentication
                        loadVendors();
                    }
                })
                .catch(error => {
                    console.error('Error checking admin status:', error);
                    window.location.href = 'login.html';
                });

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('../php/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
            });

            // Add event listeners for vendor management
            setupEventListeners();
        });

        // Current page and search variables
        let currentPage = 1;
        let searchTerm = '';
        let statusFilter = '';
        let vendorToDelete = null;

        function setupEventListeners() {
            // Add Vendor button
            document.getElementById('add-vendor-btn').addEventListener('click', function() {
                document.getElementById('modal-title').textContent = 'Add New Vendor';
                document.getElementById('vendor-form').reset();
                document.getElementById('vendor-id').value = '';
                // Set default commission rate
                document.getElementById('vendor-commission').value = '10.0';
                openModal('vendor-modal');
            });

            // Search button
            document.getElementById('search-btn').addEventListener('click', function() {
                searchTerm = document.getElementById('search-input').value;
                currentPage = 1;
                loadVendors();
            });

            // Enter key in search input
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchTerm = document.getElementById('search-input').value;
                    currentPage = 1;
                    loadVendors();
                }
            });

            // Status filter
            document.getElementById('status-filter').addEventListener('change', function() {
                statusFilter = this.value;
                currentPage = 1;
                loadVendors();
            });

            // Pagination buttons
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadVendors();
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                currentPage++;
                loadVendors();
            });

            // Vendor form submission
            document.getElementById('vendor-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveVendor();
            });

            // Cancel button in form
            document.getElementById('cancel-btn').addEventListener('click', function() {
                closeModal('vendor-modal');
            });

            // Close buttons for modals
            document.querySelectorAll('.close').forEach(function(closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAllModals();
                });
            });

            // Confirm delete buttons
            document.getElementById('cancel-delete-btn').addEventListener('click', function() {
                closeModal('confirm-modal');
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                if (vendorToDelete) {
                    deleteVendor(vendorToDelete);
                }
            });
        }

        function loadVendors() {
            const url = `../php/admin/get_vendors.php?page=${currentPage}&search=${searchTerm}&status=${statusFilter}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading vendors:', data.error);
                        return;
                    }
                    
                    renderVendors(data.vendors);
                    updatePagination(data.currentPage, data.totalPages);
                })
                .catch(error => console.error('Error loading vendors:', error));
        }

        function renderVendors(vendors) {
            const tableBody = document.querySelector('#vendors-table tbody');
            tableBody.innerHTML = '';
            
            if (vendors.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="7" class="text-center">No vendors found</td>';
                tableBody.appendChild(emptyRow);
                return;
            }
            
            vendors.forEach(vendor => {
                const row = document.createElement('tr');
                const statusBadge = vendor.is_active == 1 
                    ? '<span class="badge success">Active</span>' 
                    : '<span class="badge danger">Inactive</span>';
                
                row.innerHTML = `
                    <td>${vendor.id}</td>
                    <td>${vendor.name}</td>
                    <td>${vendor.email}</td>
                    <td>${vendor.phone || '-'}</td>
                    <td>${vendor.product_count || 0}</td>
                    <td>${statusBadge}</td>
                    <td class="actions">
                        <button class="btn icon view-btn" data-id="${vendor.id}"><i class="material-icons">visibility</i></button>
                        <button class="btn icon edit-btn" data-id="${vendor.id}"><i class="material-icons">edit</i></button>
                        <button class="btn icon delete-btn" data-id="${vendor.id}"><i class="material-icons">delete</i></button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners for view, edit and delete buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const vendorId = this.getAttribute('data-id');
                    viewVendorDetails(vendorId);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const vendorId = this.getAttribute('data-id');
                    editVendor(vendorId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const vendorId = this.getAttribute('data-id');
                    confirmDelete(vendorId);
                });
            });
        }

        function updatePagination(currentPage, totalPages) {
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function viewVendorDetails(vendorId) {
            fetch(`../php/admin/get_vendor.php?id=${vendorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching vendor details:', data.error);
                        return;
                    }
                    
                    // Populate vendor details
                    document.getElementById('detail-id').textContent = data.id;
                    document.getElementById('detail-name').textContent = data.name;
                    document.getElementById('detail-email').textContent = data.email;
                    document.getElementById('detail-phone').textContent = data.phone || '-';
                    document.getElementById('detail-address').textContent = data.address || '-';
                    document.getElementById('detail-description').textContent = data.description || '-';
                    document.getElementById('detail-commission').textContent = data.commission_rate + '%';
                    document.getElementById('detail-status').textContent = data.is_active == 1 ? 'Active' : 'Inactive';
                    document.getElementById('detail-created').textContent = new Date(data.created_at).toLocaleDateString();
                    
                    // Populate vendor products
                    const productsTable = document.querySelector('#vendor-products-table tbody');
                    productsTable.innerHTML = '';
                    
                    if (!data.products || data.products.length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = '<td colspan="6" class="text-center">No products found</td>';
                        productsTable.appendChild(emptyRow);
                    } else {
                        data.products.forEach(product => {
                            const productRow = document.createElement('tr');
                            const productStatus = product.is_active == 1 
                                ? '<span class="badge success">Active</span>' 
                                : '<span class="badge danger">Inactive</span>';
                            
                            productRow.innerHTML = `
                                <td>${product.id}</td>
                                <td><img src="../uploads/products/${product.image || 'no-image.jpg'}" alt="${product.name}" class="thumbnail"></td>
                                <td>${product.name}</td>
                                <td>$${parseFloat(product.price).toFixed(2)}</td>
                                <td>${product.stock}</td>
                                <td>${productStatus}</td>
                            `;
                            
                            productsTable.appendChild(productRow);
                        });
                    }
                    
                    openModal('vendor-details-modal');
                })
                .catch(error => console.error('Error fetching vendor details:', error));
        }

        function editVendor(vendorId) {
            fetch(`../php/admin/get_vendor.php?id=${vendorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching vendor:', data.error);
                        return;
                    }
                    
                    // Populate form with vendor data
                    document.getElementById('modal-title').textContent = 'Edit Vendor';
                    document.getElementById('vendor-id').value = data.id;
                    document.getElementById('vendor-name').value = data.name;
                    document.getElementById('vendor-email').value = data.email;
                    document.getElementById('vendor-phone').value = data.phone || '';
                    document.getElementById('vendor-address').value = data.address || '';
                    document.getElementById('vendor-description').value = data.description || '';
                    document.getElementById('vendor-commission').value = data.commission_rate;
                    document.getElementById('vendor-status').value = data.is_active;
                    
                    openModal('vendor-modal');
                })
                .catch(error => console.error('Error fetching vendor:', error));
        }

        function saveVendor() {
            const vendorId = document.getElementById('vendor-id').value;
            const endpoint = vendorId ? '../php/admin/update_vendor.php' : '../php/admin/add_vendor.php';
            
            const formData = {
                id: vendorId,
                name: document.getElementById('vendor-name').value,
                email: document.getElementById('vendor-email').value,
                phone: document.getElementById('vendor-phone').value,
                address: document.getElementById('vendor-address').value,
                description: document.getElementById('vendor-description').value,
                commission_rate: document.getElementById('vendor-commission').value,
                is_active: document.getElementById('vendor-status').value
            };
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('vendor-modal');
                    loadVendors();
                } else {
                    alert(data.message || 'Error saving vendor');
                }
            })
            .catch(error => console.error('Error saving vendor:', error));
        }

        function confirmDelete(vendorId) {
            vendorToDelete = vendorId;
            openModal('confirm-modal');
        }

        function deleteVendor(vendorId) {
            fetch('../php/admin/delete_vendor.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: vendorId })
            })
            .then(response => response.json())
            .then(data => {
                closeModal('confirm-modal');
                if (data.success) {
                    loadVendors();
                } else {
                    alert(data.message || 'Error deleting vendor');
                }
            })
            .catch(error => console.error('Error deleting vendor:', error));
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    </script>
</body>
</html>
