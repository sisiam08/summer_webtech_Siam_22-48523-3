<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile - Shop Owner Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/shop_owner.css">
</head>
<body class="shop-owner">
    <div class="shop-owner-sidebar">
        <div class="brand">
            Shop Dashboard
        </div>
        <div class="menu">
            <a href="index.html" class="menu-item">
                <i class="material-icons">dashboard</i> <span>Dashboard</span>
            </a>
            <a href="products.html" class="menu-item">
                <i class="material-icons">inventory</i> <span>Products</span>
            </a>
            <a href="orders.html" class="menu-item">
                <i class="material-icons">shopping_cart</i> <span>Orders</span>
            </a>
            <a href="reports.html" class="menu-item">
                <i class="material-icons">bar_chart</i> <span>Reports</span>
            </a>
            <a href="profile.html" class="menu-item active">
                <i class="material-icons">store</i> <span>Shop Profile</span>
            </a>
        </div>
    </div>

    <div class="shop-owner-content">
        <div class="shop-owner-header">
            <h2>Shop Profile</h2>
            <div class="user-info">
                <div class="dropdown">
                    <span id="shop-owner-name">Shop Owner</span>
                    <i class="material-icons">arrow_drop_down</i>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="#" id="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-container">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="shop-logo" src="../uploads/shops/default-shop.png" alt="Shop Logo">
                        <div class="avatar-upload">
                            <label for="logo-upload" class="btn primary">
                                <i class="material-icons">photo_camera</i>
                            </label>
                            <input type="file" id="logo-upload" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h3 id="shop-name">Shop Name</h3>
                        <p id="shop-status">Status: <span class="badge success">Active</span></p>
                    </div>
                </div>

                <div class="form-tabs">
                    <button class="tab-btn active" data-tab="shop-info">Shop Information</button>
                    <button class="tab-btn" data-tab="account-info">Account Information</button>
                    <button class="tab-btn" data-tab="password">Change Password</button>
                </div>

                <div class="tab-content" id="shop-info">
                    <form id="shop-info-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shop-name-input">Shop Name</label>
                                <input type="text" id="shop-name-input" name="shop_name" placeholder="Enter shop name" required>
                            </div>
                            <div class="form-group">
                                <label for="shop-phone">Phone Number</label>
                                <input type="tel" id="shop-phone" name="phone" placeholder="Enter phone number" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="shop-description">Shop Description</label>
                            <textarea id="shop-description" name="description" rows="4" placeholder="Describe your shop and what you offer"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shop-address">Address</label>
                                <input type="text" id="shop-address" name="address" placeholder="Enter shop address" required>
                            </div>
                            <div class="form-group">
                                <label for="shop-city">City</label>
                                <input type="text" id="shop-city" name="city" placeholder="Enter city" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shop-postal">Postal Code</label>
                                <input type="text" id="shop-postal" name="postal_code" placeholder="Enter postal code">
                            </div>
                            <div class="form-group">
                                <label for="shop-country">Country</label>
                                <input type="text" id="shop-country" name="country" placeholder="Enter country" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shop-business-hours">Business Hours</label>
                                <input type="text" id="shop-business-hours" name="business_hours" placeholder="e.g., Mon-Fri: 9 AM - 6 PM">
                            </div>
                            <div class="form-group">
                                <label for="shop-category">Shop Category</label>
                                <select id="shop-category" name="category_id">
                                    <!-- Categories will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn primary">Save Shop Information</button>
                        </div>
                    </form>
                </div>

                <div class="tab-content" id="account-info" style="display: none;">
                    <form id="account-info-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">First Name</label>
                                <input type="text" id="first-name" name="first_name" placeholder="Enter first name" required>
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name</label>
                                <input type="text" id="last-name" name="last_name" placeholder="Enter last name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" placeholder="Enter email address" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" placeholder="Enter phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn primary">Save Account Information</button>
                        </div>
                    </form>
                </div>

                <div class="tab-content" id="password" style="display: none;">
                    <form id="password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="current_password" placeholder="Enter current password" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" name="new_password" placeholder="Enter new password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm new password" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn primary">Change Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if shop owner is logged in
            fetch('../php/shop_owner/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'shop_owner') {
                        window.location.href = 'login.html';
                    } else {
                        document.getElementById('shop-owner-name').textContent = data.name;
                        
                        // Load shop profile data
                        loadShopProfile();
                        
                        // Load shop categories
                        loadShopCategories();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = 'login.html';
                });
        });

        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('../php/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
            });
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Show selected tab content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).style.display = 'block';
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                });
            });
            
            // Logo upload
            document.getElementById('logo-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const formData = new FormData();
                    formData.append('logo', e.target.files[0]);
                    
                    fetch('../php/shop_owner/update_shop_logo.php', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update logo preview
                                document.getElementById('shop-logo').src = '../uploads/shops/' + data.logo + '?v=' + new Date().getTime();
                                alert('Shop logo updated successfully');
                            } else {
                                alert('Error updating shop logo: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating shop logo:', error);
                            alert('An error occurred while updating the shop logo');
                        });
                }
            });
            
            // Form submissions
            document.getElementById('shop-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateShopInfo();
            });
            
            document.getElementById('account-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateAccountInfo();
            });
            
            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updatePassword();
            });
        }

        function loadShopProfile() {
            fetch('../php/shop_owner/get_shop_profile.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading shop profile:', data.error);
                        return;
                    }
                    
                    // Set shop information
                    const shop = data.shop;
                    document.getElementById('shop-name').textContent = shop.name;
                    document.getElementById('shop-logo').src = '../uploads/shops/' + (shop.logo || 'default-shop.png');
                    
                    // Set shop status
                    const statusBadge = document.querySelector('#shop-status .badge');
                    if (shop.is_active) {
                        statusBadge.className = 'badge success';
                        statusBadge.textContent = 'Active';
                    } else {
                        statusBadge.className = 'badge danger';
                        statusBadge.textContent = 'Inactive';
                    }
                    
                    // Set shop info form values
                    document.getElementById('shop-name-input').value = shop.name;
                    document.getElementById('shop-phone').value = shop.phone || '';
                    document.getElementById('shop-description').value = shop.description || '';
                    document.getElementById('shop-address').value = shop.address || '';
                    document.getElementById('shop-city').value = shop.city || '';
                    document.getElementById('shop-postal').value = shop.postal_code || '';
                    document.getElementById('shop-country').value = shop.country || '';
                    document.getElementById('shop-business-hours').value = shop.business_hours || '';
                    
                    if (shop.category_id) {
                        document.getElementById('shop-category').value = shop.category_id;
                    }
                    
                    // Set account info form values
                    const owner = data.owner;
                    document.getElementById('first-name').value = owner.first_name;
                    document.getElementById('last-name').value = owner.last_name;
                    document.getElementById('email').value = owner.email;
                    document.getElementById('phone').value = owner.phone || '';
                })
                .catch(error => console.error('Error loading shop profile:', error));
        }

        function loadShopCategories() {
            fetch('../php/get_shop_categories.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading shop categories:', data.error);
                        return;
                    }
                    
                    const categorySelect = document.getElementById('shop-category');
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select a category';
                    categorySelect.appendChild(defaultOption);
                    
                    // Add categories
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading shop categories:', error));
        }

        function updateShopInfo() {
            const formData = new FormData(document.getElementById('shop-info-form'));
            
            fetch('../php/shop_owner/update_shop_info.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update shop name in the header
                        document.getElementById('shop-name').textContent = formData.get('shop_name');
                        
                        alert('Shop information updated successfully');
                    } else {
                        alert('Error updating shop information: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating shop information:', error);
                    alert('An error occurred while updating shop information');
                });
        }

        function updateAccountInfo() {
            const formData = new FormData(document.getElementById('account-info-form'));
            
            fetch('../php/shop_owner/update_account_info.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update owner name in the header
                        document.getElementById('shop-owner-name').textContent = 
                            formData.get('first_name') + ' ' + formData.get('last_name');
                        
                        alert('Account information updated successfully');
                    } else {
                        alert('Error updating account information: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating account information:', error);
                    alert('An error occurred while updating account information');
                });
        }

        function updatePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('New password and confirm password do not match');
                return;
            }
            
            const formData = new FormData(document.getElementById('password-form'));
            
            fetch('../php/shop_owner/update_password.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Password updated successfully');
                        
                        // Clear password fields
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                    } else {
                        alert('Error updating password: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating password:', error);
                    alert('An error occurred while updating password');
                });
        }
    </script>
</body>
</html>
