<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - Shop Owner Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/shop_owner.css">
</head>
<body class="shop-owner">
    <div class="shop-owner-sidebar">
        <div class="brand">
            Shop Dashboard
        </div>
        <div class="menu">
            <a href="index.html" class="menu-item">
                <i class="material-icons">dashboard</i> <span>Dashboard</span>
            </a>
            <a href="products.html" class="menu-item active">
                <i class="material-icons">inventory</i> <span>Products</span>
            </a>
            <a href="orders.html" class="menu-item">
                <i class="material-icons">shopping_cart</i> <span>Orders</span>
            </a>
            <a href="reports.html" class="menu-item">
                <i class="material-icons">bar_chart</i> <span>Reports</span>
            </a>
            <a href="profile.html" class="menu-item">
                <i class="material-icons">store</i> <span>Shop Profile</span>
            </a>
        </div>
    </div>

    <div class="shop-owner-content">
        <div class="shop-owner-header">
            <h2>Manage Products</h2>
            <div class="user-info">
                <div class="dropdown">
                    <span id="shop-owner-name">Shop Owner</span>
                    <i class="material-icons">arrow_drop_down</i>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="#" id="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions-bar">
            <div class="search-box">
                <input type="text" id="search-products" placeholder="Search products...">
                <i class="material-icons">search</i>
            </div>
            <div class="filters">
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <!-- Categories will be populated by JavaScript -->
                </select>
                <select id="status-filter">
                    <option value="">All Stock Status</option>
                    <option value="in-stock">In Stock</option>
                    <option value="low-stock">Low Stock (â‰¤ 10)</option>
                    <option value="out-of-stock">Out of Stock</option>
                </select>
            </div>
            <a href="add-product.html" class="btn primary">
                <i class="material-icons">add</i> Add New Product
            </a>
        </div>

        <div class="data-table-container">
            <table class="data-table" id="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Products will be populated by JavaScript -->
                </tbody>
            </table>
            <div class="pagination" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="cancel-delete">Cancel</button>
                <button class="btn danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let productsPerPage = 10;
        let currentProductId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if shop owner is logged in
            fetch('../php/shop_owner/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'shop_owner') {
                        window.location.href = 'login.html';
                    } else {
                        document.getElementById('shop-owner-name').textContent = data.name;
                        
                        // Load products and categories
                        loadProducts();
                        loadCategories();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = 'login.html';
                });
        });

        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('../php/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
            });
            
            // Search products
            document.getElementById('search-products').addEventListener('input', function() {
                currentPage = 1;
                loadProducts();
            });
            
            // Filter by category
            document.getElementById('category-filter').addEventListener('change', function() {
                currentPage = 1;
                loadProducts();
            });
            
            // Filter by stock status
            document.getElementById('status-filter').addEventListener('change', function() {
                currentPage = 1;
                loadProducts();
            });
            
            // Modal functionality
            const modal = document.getElementById('delete-modal');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancel-delete');
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Close modal if clicked outside
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Delete confirmation
            document.getElementById('confirm-delete').addEventListener('click', function() {
                if (currentProductId) {
                    deleteProduct(currentProductId);
                }
            });
        }

        function loadProducts() {
            const searchQuery = document.getElementById('search-products').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            let url = `../php/shop_owner/get_products.php?page=${currentPage}&limit=${productsPerPage}`;
            
            if (searchQuery) {
                url += `&search=${encodeURIComponent(searchQuery)}`;
            }
            
            if (categoryFilter) {
                url += `&category=${encodeURIComponent(categoryFilter)}`;
            }
            
            if (statusFilter) {
                url += `&status=${encodeURIComponent(statusFilter)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading products:', data.error);
                        return;
                    }
                    
                    renderProducts(data.products);
                    renderPagination(data.totalProducts);
                })
                .catch(error => console.error('Error loading products:', error));
        }

        function loadCategories() {
            fetch('../php/get_categories.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading categories:', data.error);
                        return;
                    }
                    
                    const categorySelect = document.getElementById('category-filter');
                    
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading categories:', error));
        }

        function renderProducts(products) {
            const tableBody = document.querySelector('#products-table tbody');
            tableBody.innerHTML = '';
            
            if (products.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="8" class="text-center">No products found</td>';
                tableBody.appendChild(emptyRow);
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                
                // Create stock class based on quantity
                let stockClass = 'success';
                let stockStatus = 'In Stock';
                
                if (product.stock <= 0) {
                    stockClass = 'danger';
                    stockStatus = 'Out of Stock';
                } else if (product.stock <= 10) {
                    stockClass = 'warning';
                    stockStatus = 'Low Stock';
                }
                
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td><img src="../uploads/products/${product.image || 'no-image.jpg'}" alt="${product.name}" class="thumbnail"></td>
                    <td>${product.name}</td>
                    <td>${product.category_name || 'Uncategorized'}</td>
                    <td>$${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.stock}</td>
                    <td><span class="badge ${stockClass}">${stockStatus}</span></td>
                    <td class="actions">
                        <a href="edit-product.html?id=${product.id}" class="btn icon primary">
                            <i class="material-icons">edit</i>
                        </a>
                        <button class="btn icon danger delete-product" data-id="${product.id}">
                            <i class="material-icons">delete</i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-product').forEach(button => {
                button.addEventListener('click', function() {
                    currentProductId = this.getAttribute('data-id');
                    openModal();
                });
            });
        }

        function renderPagination(totalProducts) {
            totalPages = Math.ceil(totalProducts / productsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn pagination-btn' + (currentPage === 1 ? ' disabled' : '');
            prevBtn.innerHTML = '<i class="material-icons">chevron_left</i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadProducts();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'btn pagination-btn' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    loadProducts();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn pagination-btn' + (currentPage === totalPages ? ' disabled' : '');
            nextBtn.innerHTML = '<i class="material-icons">chevron_right</i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadProducts();
                }
            });
            pagination.appendChild(nextBtn);
        }

        function openModal() {
            document.getElementById('delete-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('delete-modal').style.display = 'none';
            currentProductId = null;
        }

        function deleteProduct(productId) {
            fetch('../php/shop_owner/delete_product.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `id=${productId}`
            })
                .then(response => response.json())
                .then(data => {
                    closeModal();
                    
                    if (data.success) {
                        // Show success notification
                        alert('Product deleted successfully');
                        
                        // Reload products
                        loadProducts();
                    } else {
                        // Show error notification
                        alert('Error deleting product: ' + data.error);
                    }
                })
                .catch(error => {
                    closeModal();
                    console.error('Error deleting product:', error);
                    alert('An error occurred while deleting the product');
                });
        }
    </script>
</body>
</html>
