<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Online Grocery Store</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/customer.css">
</head>
<body class="customer-dashboard">
    <header>
        <div class="container">
            <h1>Online Grocery Store</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="cart.html">Cart</a></li>
                    <li><a href="account.html" class="active">My Account</a></li>
                    <li><a href="#" id="logout-btn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container dashboard-container">
        <div class="dashboard-sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="material-icons">account_circle</i>
                </div>
                <div class="user-details">
                    <h3 id="customer-name">Welcome back!</h3>
                    <p id="customer-email">Loading...</p>
                </div>
            </div>
            <nav class="dashboard-nav">
                <ul>
                    <li class="active">
                        <a href="account.html">
                            <i class="material-icons">dashboard</i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="orders.html">
                            <i class="material-icons">shopping_bag</i>
                            My Orders
                        </a>
                    </li>
                    <li>
                        <a href="addresses.html">
                            <i class="material-icons">location_on</i>
                            My Addresses
                        </a>
                    </li>
                    <li>
                        <a href="wishlist.html">
                            <i class="material-icons">favorite</i>
                            Wishlist
                        </a>
                    </li>
                    <li>
                        <a href="profile.html">
                            <i class="material-icons">person</i>
                            Edit Profile
                        </a>
                    </li>
                    <li>
                        <a href="#" id="sidebar-logout">
                            <i class="material-icons">exit_to_app</i>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <div class="dashboard-content">
            <h2>My Dashboard</h2>
            
            <div class="dashboard-summary">
                <div class="summary-card">
                    <div class="icon">
                        <i class="material-icons">shopping_bag</i>
                    </div>
                    <div class="content">
                        <h3 id="total-orders">0</h3>
                        <p>Total Orders</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon">
                        <i class="material-icons">pending</i>
                    </div>
                    <div class="content">
                        <h3 id="pending-orders">0</h3>
                        <p>Pending Orders</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon">
                        <i class="material-icons">location_on</i>
                    </div>
                    <div class="content">
                        <h3 id="saved-addresses">0</h3>
                        <p>Saved Addresses</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon">
                        <i class="material-icons">favorite</i>
                    </div>
                    <div class="content">
                        <h3 id="wishlist-items">0</h3>
                        <p>Wishlist Items</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-sections">
                <div class="section">
                    <div class="section-header">
                        <h3>Recent Orders</h3>
                        <a href="orders.html" class="view-all">View All</a>
                    </div>
                    <div class="section-content" id="recent-orders">
                        <p class="loading">Loading recent orders...</p>
                        <!-- Orders will be loaded dynamically -->
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Default Address</h3>
                        <a href="addresses.html" class="view-all">Manage Addresses</a>
                    </div>
                    <div class="section-content" id="default-address">
                        <p class="loading">Loading default address...</p>
                        <!-- Default address will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Online Grocery Store. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            fetch('php/customer/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'customer') {
                        window.location.href = 'login.html';
                    } else {
                        // Set user information
                        document.getElementById('customer-name').textContent = `Welcome, ${data.name}!`;
                        document.getElementById('customer-email').textContent = data.email;
                        
                        // Load dashboard data
                        loadDashboardSummary();
                        loadRecentOrders();
                        loadDefaultAddress();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = 'login.html';
                });

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('sidebar-logout').addEventListener('click', logout);
            
            function logout(e) {
                e.preventDefault();
                fetch('php/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
            }
        });

        function loadDashboardSummary() {
            fetch('php/customer/get_dashboard_summary.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading dashboard summary:', data.error);
                        return;
                    }
                    
                    document.getElementById('total-orders').textContent = data.totalOrders;
                    document.getElementById('pending-orders').textContent = data.pendingOrders;
                    document.getElementById('saved-addresses').textContent = data.savedAddresses;
                    document.getElementById('wishlist-items').textContent = data.wishlistItems;
                })
                .catch(error => console.error('Error loading dashboard summary:', error));
        }

        function loadRecentOrders() {
            fetch('php/customer/get_recent_orders.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading recent orders:', data.error);
                        document.getElementById('recent-orders').innerHTML = `<p class="empty-message">Error loading recent orders.</p>`;
                        return;
                    }
                    
                    if (data.orders.length === 0) {
                        document.getElementById('recent-orders').innerHTML = `
                            <p class="empty-message">You haven't placed any orders yet.</p>
                            <a href="products.html" class="btn primary">Start Shopping</a>
                        `;
                        return;
                    }
                    
                    let ordersHtml = '<div class="orders-list">';
                    
                    data.orders.forEach(order => {
                        // Create status badge
                        let statusClass;
                        switch (order.status) {
                            case 'pending':
                                statusClass = 'warning';
                                break;
                            case 'processing':
                                statusClass = 'info';
                                break;
                            case 'shipped':
                                statusClass = 'primary';
                                break;
                            case 'delivered':
                                statusClass = 'success';
                                break;
                            case 'cancelled':
                                statusClass = 'danger';
                                break;
                            default:
                                statusClass = 'secondary';
                        }
                        
                        ordersHtml += `
                            <div class="order-item">
                                <div class="order-info">
                                    <h4>Order #${order.order_number}</h4>
                                    <p>Date: ${new Date(order.created_at).toLocaleDateString()}</p>
                                    <p>Total: $${parseFloat(order.total_amount).toFixed(2)}</p>
                                </div>
                                <div class="order-status">
                                    <span class="badge ${statusClass}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                                </div>
                                <div class="order-actions">
                                    <a href="order-details.html?id=${order.id}" class="btn secondary">View Details</a>
                                </div>
                            </div>
                        `;
                    });
                    
                    ordersHtml += '</div>';
                    document.getElementById('recent-orders').innerHTML = ordersHtml;
                })
                .catch(error => console.error('Error loading recent orders:', error));
        }

        function loadDefaultAddress() {
            fetch('php/customer/get_default_address.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading default address:', data.error);
                        document.getElementById('default-address').innerHTML = `<p class="empty-message">Error loading address.</p>`;
                        return;
                    }
                    
                    if (!data.address) {
                        document.getElementById('default-address').innerHTML = `
                            <p class="empty-message">You don't have a default address set up.</p>
                            <a href="addresses.html" class="btn primary">Add Address</a>
                        `;
                        return;
                    }
                    
                    const address = data.address;
                    const addressHtml = `
                        <div class="address-card">
                            <h4>${address.name}</h4>
                            <p>${address.address_line}</p>
                            <p>${address.city}, ${address.postal_code}</p>
                            <p>${address.country}</p>
                            <p>Phone: ${address.phone}</p>
                            <div class="address-actions">
                                <a href="addresses.html" class="btn secondary">Edit</a>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('default-address').innerHTML = addressHtml;
                })
                .catch(error => console.error('Error loading default address:', error));
        }
    </script>
</body>
</html>
