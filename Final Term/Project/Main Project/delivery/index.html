<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard - Online Grocery Store</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/delivery.css">
</head>
<body class="delivery-dashboard">
    <header>
        <div class="container">
            <h1>Online Grocery Store</h1>
            <nav>
                <ul>
                    <li><a href="index.html" class="active">Dashboard</a></li>
                    <li><a href="assignments.html">My Assignments</a></li>
                    <li><a href="completed.html">Completed Deliveries</a></li>
                    <li><a href="profile.html">My Profile</a></li>
                    <li><a href="#" id="logout-btn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container dashboard-container">
        <div class="dashboard-sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="material-icons">directions_bike</i>
                </div>
                <div class="user-details">
                    <h3 id="delivery-person-name">Welcome back!</h3>
                    <p id="delivery-person-email">Loading...</p>
                </div>
            </div>
            <nav class="dashboard-nav">
                <ul>
                    <li class="active">
                        <a href="index.html">
                            <i class="material-icons">dashboard</i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="assignments.html">
                            <i class="material-icons">assignment</i>
                            My Assignments
                        </a>
                    </li>
                    <li>
                        <a href="completed.html">
                            <i class="material-icons">check_circle</i>
                            Completed Deliveries
                        </a>
                    </li>
                    <li>
                        <a href="profile.html">
                            <i class="material-icons">person</i>
                            My Profile
                        </a>
                    </li>
                    <li>
                        <a href="#" id="sidebar-logout">
                            <i class="material-icons">exit_to_app</i>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <div class="dashboard-content">
            <h2>Delivery Dashboard</h2>
            
            <div class="dashboard-status">
                <div class="status-card" id="status-card">
                    <div class="status-icon">
                        <i class="material-icons">circle</i>
                    </div>
                    <div class="status-info">
                        <h3>Current Status</h3>
                        <p id="current-status">Loading...</p>
                    </div>
                    <button id="toggle-status-btn" class="btn primary">Go Online</button>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">pending_actions</i>
                    </div>
                    <div class="stat-info">
                        <h3>Pending</h3>
                        <p id="pending-count">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">local_shipping</i>
                    </div>
                    <div class="stat-info">
                        <h3>In Progress</h3>
                        <p id="inprogress-count">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">check_circle</i>
                    </div>
                    <div class="stat-info">
                        <h3>Completed</h3>
                        <p id="completed-count">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">star</i>
                    </div>
                    <div class="stat-info">
                        <h3>Rating</h3>
                        <p id="rating">0.0</p>
                    </div>
                </div>
            </div>
            
            <div class="current-delivery-container" id="current-delivery-container">
                <!-- Current delivery will be shown here if available -->
            </div>
            
            <div class="upcoming-assignments">
                <div class="section-header">
                    <h3>New Assignments</h3>
                </div>
                <div id="assignments-container">
                    <p class="loading">Loading assignments...</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Online Grocery Store. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            fetch('../php/delivery/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'delivery') {
                        window.location.href = '../login.html';
                    } else {
                        // Set user information
                        document.getElementById('delivery-person-name').textContent = `Welcome, ${data.name}!`;
                        document.getElementById('delivery-person-email').textContent = data.email;
                        
                        // Load dashboard data
                        loadDashboardData();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = '../login.html';
                });
        });
        
        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('sidebar-logout').addEventListener('click', logout);
            
            // Toggle status button
            document.getElementById('toggle-status-btn').addEventListener('click', toggleStatus);
        }
        
        function logout(e) {
            e.preventDefault();
            fetch('../php/logout.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '../login.html';
                    }
                })
                .catch(error => console.error('Error logging out:', error));
        }
        
        function loadDashboardData() {
            // Fetch dashboard summary data
            fetch('../php/delivery/get_dashboard_summary.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading dashboard data:', data.error);
                        return;
                    }
                    
                    // Update statistics
                    document.getElementById('pending-count').textContent = data.stats.pending || 0;
                    document.getElementById('inprogress-count').textContent = data.stats.in_progress || 0;
                    document.getElementById('completed-count').textContent = data.stats.completed || 0;
                    document.getElementById('rating').textContent = parseFloat(data.stats.rating || 0).toFixed(1);
                    
                    // Update status
                    updateStatusUI(data.status);
                    
                    // Load current delivery if exists
                    if (data.current_delivery) {
                        showCurrentDelivery(data.current_delivery);
                    } else {
                        document.getElementById('current-delivery-container').innerHTML = '';
                    }
                    
                    // Load new assignments
                    loadNewAssignments();
                })
                .catch(error => console.error('Error loading dashboard data:', error));
        }
        
        function updateStatusUI(status) {
            const statusCard = document.getElementById('status-card');
            const statusText = document.getElementById('current-status');
            const toggleBtn = document.getElementById('toggle-status-btn');
            const statusIcon = statusCard.querySelector('.status-icon i');
            
            if (status === 'online') {
                statusCard.classList.remove('offline');
                statusCard.classList.add('online');
                statusText.textContent = 'You are currently ONLINE';
                toggleBtn.textContent = 'Go Offline';
                statusIcon.textContent = 'circle';
                statusIcon.style.color = '#4CAF50';
            } else {
                statusCard.classList.remove('online');
                statusCard.classList.add('offline');
                statusText.textContent = 'You are currently OFFLINE';
                toggleBtn.textContent = 'Go Online';
                statusIcon.textContent = 'circle';
                statusIcon.style.color = '#F44336';
            }
        }
        
        function toggleStatus() {
            const currentStatus = document.getElementById('toggle-status-btn').textContent === 'Go Offline' ? 'online' : 'offline';
            const newStatus = currentStatus === 'online' ? 'offline' : 'online';
            
            fetch('../php/delivery/update_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating status: ' + data.error);
                } else {
                    updateStatusUI(newStatus);
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
                alert('An error occurred while updating your status. Please try again.');
            });
        }
        
        function showCurrentDelivery(delivery) {
            const container = document.getElementById('current-delivery-container');
            
            // Format the order date
            const orderDate = new Date(delivery.created_at);
            const formattedDate = `${orderDate.toLocaleDateString()} ${orderDate.toLocaleTimeString()}`;
            
            // Create estimated delivery time
            const estimatedDelivery = new Date(delivery.estimated_delivery);
            const formattedEstimatedDelivery = `${estimatedDelivery.toLocaleDateString()} ${estimatedDelivery.toLocaleTimeString()}`;
            
            container.innerHTML = `
                <div class="section-header">
                    <h3>Current Delivery</h3>
                </div>
                <div class="current-delivery">
                    <div class="delivery-header">
                        <div class="delivery-info">
                            <h4>Order #${delivery.order_number}</h4>
                            <p class="delivery-meta">Ordered: ${formattedDate}</p>
                            <p class="delivery-meta">Estimated Delivery: ${formattedEstimatedDelivery}</p>
                        </div>
                        <div class="delivery-status">
                            <span class="badge primary">${delivery.status.charAt(0).toUpperCase() + delivery.status.slice(1)}</span>
                        </div>
                    </div>
                    <div class="delivery-address">
                        <h4>Delivery Address</h4>
                        <p>${delivery.address.name}</p>
                        <p>${delivery.address.address_line1}</p>
                        ${delivery.address.address_line2 ? `<p>${delivery.address.address_line2}</p>` : ''}
                        <p>${delivery.address.city}, ${delivery.address.state} ${delivery.address.postal_code}</p>
                        <p>Phone: ${delivery.address.phone}</p>
                    </div>
                    <div class="delivery-summary">
                        <h4>Order Summary</h4>
                        <p><strong>Items:</strong> ${delivery.item_count}</p>
                        <p><strong>Total:</strong> $${parseFloat(delivery.total_amount).toFixed(2)}</p>
                        <p><strong>Payment Method:</strong> ${delivery.payment_method || 'N/A'}</p>
                    </div>
                    <div class="delivery-actions">
                        <a href="delivery-details.html?id=${delivery.id}" class="btn secondary">View Details</a>
                        <button class="btn primary update-status-btn" data-id="${delivery.id}" data-status="${delivery.status}">
                            ${getNextStatusButtonText(delivery.status)}
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listener to update status button
            const updateStatusBtn = container.querySelector('.update-status-btn');
            updateStatusBtn.addEventListener('click', function() {
                updateDeliveryStatus(this.getAttribute('data-id'), this.getAttribute('data-status'));
            });
        }
        
        function getNextStatusButtonText(currentStatus) {
            switch (currentStatus) {
                case 'assigned':
                    return 'Start Delivery';
                case 'picked_up':
                    return 'Mark as Delivered';
                default:
                    return 'Update Status';
            }
        }
        
        function updateDeliveryStatus(deliveryId, currentStatus) {
            let newStatus;
            let confirmMessage;
            
            switch (currentStatus) {
                case 'assigned':
                    newStatus = 'picked_up';
                    confirmMessage = 'Have you picked up this order and started the delivery?';
                    break;
                case 'picked_up':
                    newStatus = 'delivered';
                    confirmMessage = 'Confirm that you have delivered this order to the customer?';
                    break;
                default:
                    return;
            }
            
            if (confirm(confirmMessage)) {
                fetch('../php/delivery/update_delivery_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        delivery_id: deliveryId,
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error updating delivery status: ' + data.error);
                    } else {
                        // Reload dashboard data
                        loadDashboardData();
                    }
                })
                .catch(error => {
                    console.error('Error updating delivery status:', error);
                    alert('An error occurred while updating the delivery status. Please try again.');
                });
            }
        }
        
        function loadNewAssignments() {
            fetch('../php/delivery/get_new_assignments.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading assignments:', data.error);
                        document.getElementById('assignments-container').innerHTML = `
                            <p class="empty-message">Error loading assignments. Please try again.</p>
                        `;
                        return;
                    }
                    
                    renderAssignments(data.assignments);
                })
                .catch(error => {
                    console.error('Error loading assignments:', error);
                    document.getElementById('assignments-container').innerHTML = `
                        <p class="empty-message">Error loading assignments. Please try again.</p>
                    `;
                });
        }
        
        function renderAssignments(assignments) {
            const container = document.getElementById('assignments-container');
            
            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="empty-assignments">
                        <i class="material-icons">inventory</i>
                        <p>No new assignments available at the moment.</p>
                    </div>
                `;
                return;
            }
            
            let assignmentsHtml = '';
            
            assignments.forEach(assignment => {
                // Format the order date
                const orderDate = new Date(assignment.created_at);
                const formattedDate = `${orderDate.toLocaleDateString()} ${orderDate.toLocaleTimeString()}`;
                
                assignmentsHtml += `
                    <div class="assignment-card">
                        <div class="assignment-info">
                            <h4>Order #${assignment.order_number}</h4>
                            <p>Ordered: ${formattedDate}</p>
                            <p>${assignment.address.city}, ${assignment.address.state}</p>
                            <p>Items: ${assignment.item_count} | Total: $${parseFloat(assignment.total_amount).toFixed(2)}</p>
                        </div>
                        <div class="assignment-actions">
                            <a href="delivery-details.html?id=${assignment.id}" class="btn secondary">View Details</a>
                            <button class="btn primary accept-assignment-btn" data-id="${assignment.id}">Accept</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = assignmentsHtml;
            
            // Add event listeners to accept buttons
            document.querySelectorAll('.accept-assignment-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const assignmentId = this.getAttribute('data-id');
                    acceptAssignment(assignmentId);
                });
            });
        }
        
        function acceptAssignment(assignmentId) {
            if (confirm('Are you sure you want to accept this delivery assignment?')) {
                fetch('../php/delivery/accept_assignment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ delivery_id: assignmentId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error accepting assignment: ' + data.error);
                    } else {
                        alert('Assignment accepted successfully!');
                        loadDashboardData();
                    }
                })
                .catch(error => {
                    console.error('Error accepting assignment:', error);
                    alert('An error occurred while accepting the assignment. Please try again.');
                });
            }
        }
    </script>
</body>
</html>
