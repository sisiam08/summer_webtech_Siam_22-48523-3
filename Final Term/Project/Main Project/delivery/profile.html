<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Online Grocery Store</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/delivery.css">
</head>
<body class="delivery-dashboard">
    <header>
        <div class="container">
            <h1>Online Grocery Store</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="assignments.html">My Assignments</a></li>
                    <li><a href="completed.html">Completed Deliveries</a></li>
                    <li><a href="profile.html" class="active">My Profile</a></li>
                    <li><a href="#" id="logout-btn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container dashboard-container">
        <div class="dashboard-sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="material-icons">directions_bike</i>
                </div>
                <div class="user-details">
                    <h3 id="delivery-person-name">Welcome back!</h3>
                    <p id="delivery-person-email">Loading...</p>
                </div>
            </div>
            <nav class="dashboard-nav">
                <ul>
                    <li>
                        <a href="index.html">
                            <i class="material-icons">dashboard</i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="assignments.html">
                            <i class="material-icons">assignment</i>
                            My Assignments
                        </a>
                    </li>
                    <li>
                        <a href="completed.html">
                            <i class="material-icons">check_circle</i>
                            Completed Deliveries
                        </a>
                    </li>
                    <li>
                        <a href="profile.html" class="active">
                            <i class="material-icons">person</i>
                            My Profile
                        </a>
                    </li>
                    <li>
                        <a href="#" id="sidebar-logout">
                            <i class="material-icons">exit_to_app</i>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <div class="dashboard-content">
            <h2>My Profile</h2>
            <p class="section-desc">Manage your account information and settings</p>
            
            <div class="profile-tabs">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="personal">Personal Information</button>
                    <button class="tab-btn" data-tab="vehicle">Vehicle Information</button>
                    <button class="tab-btn" data-tab="bank">Payment Details</button>
                    <button class="tab-btn" data-tab="password">Change Password</button>
                </div>
                
                <div class="tab-content">
                    <!-- Personal Information Tab -->
                    <div class="tab-pane active" id="personal-tab">
                        <form id="personal-info-form" class="profile-form">
                            <div class="profile-form-header">
                                <h3>Personal Information</h3>
                                <p>Update your personal details</p>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="first-name">First Name</label>
                                    <input type="text" id="first-name" name="first_name" placeholder="First Name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="last-name">Last Name</label>
                                    <input type="text" id="last-name" name="last_name" placeholder="Last Name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" placeholder="Email Address" disabled>
                                    <small>Email cannot be changed. Contact admin for assistance.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="text" id="phone" name="phone" placeholder="Phone Number">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="address">Home Address</label>
                                    <textarea id="address" name="address" rows="3" placeholder="Your Home Address"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" name="city" placeholder="City">
                                </div>
                                
                                <div class="form-group">
                                    <label for="postal-code">Postal/ZIP Code</label>
                                    <input type="text" id="postal-code" name="postal_code" placeholder="Postal/ZIP Code">
                                </div>
                                
                                <div class="form-group">
                                    <label for="dob">Date of Birth</label>
                                    <input type="date" id="dob" name="dob">
                                </div>
                                
                                <div class="form-group">
                                    <label for="id-number">ID Number</label>
                                    <input type="text" id="id-number" name="id_number" placeholder="Government ID Number">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Vehicle Information Tab -->
                    <div class="tab-pane" id="vehicle-tab">
                        <form id="vehicle-info-form" class="profile-form">
                            <div class="profile-form-header">
                                <h3>Vehicle Information</h3>
                                <p>Update your vehicle details for delivery</p>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="vehicle-type">Vehicle Type</label>
                                    <select id="vehicle-type" name="vehicle_type">
                                        <option value="">Select Vehicle Type</option>
                                        <option value="bicycle">Bicycle</option>
                                        <option value="motorcycle">Motorcycle</option>
                                        <option value="car">Car</option>
                                        <option value="van">Van</option>
                                        <option value="truck">Truck</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="vehicle-make">Make</label>
                                    <input type="text" id="vehicle-make" name="vehicle_make" placeholder="Vehicle Make">
                                </div>
                                
                                <div class="form-group">
                                    <label for="vehicle-model">Model</label>
                                    <input type="text" id="vehicle-model" name="vehicle_model" placeholder="Vehicle Model">
                                </div>
                                
                                <div class="form-group">
                                    <label for="vehicle-year">Year</label>
                                    <input type="number" id="vehicle-year" name="vehicle_year" placeholder="Vehicle Year">
                                </div>
                                
                                <div class="form-group">
                                    <label for="license-plate">License Plate</label>
                                    <input type="text" id="license-plate" name="license_plate" placeholder="License Plate Number">
                                </div>
                                
                                <div class="form-group">
                                    <label for="vehicle-color">Color</label>
                                    <input type="text" id="vehicle-color" name="vehicle_color" placeholder="Vehicle Color">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="vehicle-notes">Additional Notes</label>
                                    <textarea id="vehicle-notes" name="vehicle_notes" rows="3" placeholder="Additional information about your vehicle"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Payment Details Tab -->
                    <div class="tab-pane" id="bank-tab">
                        <form id="bank-info-form" class="profile-form">
                            <div class="profile-form-header">
                                <h3>Payment Details</h3>
                                <p>Update your payment information for receiving earnings</p>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="payment-method">Payment Method</label>
                                    <select id="payment-method" name="payment_method">
                                        <option value="">Select Payment Method</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="paypal">PayPal</option>
                                        <option value="mobile_wallet">Mobile Wallet</option>
                                    </select>
                                </div>
                                
                                <div class="form-group bank-field">
                                    <label for="bank-name">Bank Name</label>
                                    <input type="text" id="bank-name" name="bank_name" placeholder="Bank Name">
                                </div>
                                
                                <div class="form-group bank-field">
                                    <label for="account-name">Account Holder Name</label>
                                    <input type="text" id="account-name" name="account_name" placeholder="Account Holder Name">
                                </div>
                                
                                <div class="form-group bank-field">
                                    <label for="account-number">Account Number</label>
                                    <input type="text" id="account-number" name="account_number" placeholder="Account Number">
                                </div>
                                
                                <div class="form-group bank-field">
                                    <label for="routing-number">Routing Number</label>
                                    <input type="text" id="routing-number" name="routing_number" placeholder="Routing Number">
                                </div>
                                
                                <div class="form-group paypal-field" style="display: none;">
                                    <label for="paypal-email">PayPal Email</label>
                                    <input type="email" id="paypal-email" name="paypal_email" placeholder="PayPal Email Address">
                                </div>
                                
                                <div class="form-group mobile-wallet-field" style="display: none;">
                                    <label for="wallet-type">Wallet Type</label>
                                    <select id="wallet-type" name="wallet_type">
                                        <option value="">Select Wallet Type</option>
                                        <option value="venmo">Venmo</option>
                                        <option value="cash_app">Cash App</option>
                                        <option value="apple_pay">Apple Pay</option>
                                        <option value="google_pay">Google Pay</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mobile-wallet-field" style="display: none;">
                                    <label for="wallet-id">Wallet ID/Username</label>
                                    <input type="text" id="wallet-id" name="wallet_id" placeholder="Wallet ID or Username">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Change Password Tab -->
                    <div class="tab-pane" id="password-tab">
                        <form id="password-form" class="profile-form">
                            <div class="profile-form-header">
                                <h3>Change Password</h3>
                                <p>Update your password to keep your account secure</p>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="current-password">Current Password</label>
                                    <input type="password" id="current-password" name="current_password" placeholder="Current Password">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="new-password">New Password</label>
                                    <input type="password" id="new-password" name="new_password" placeholder="New Password">
                                    <small>Password must be at least 8 characters and include uppercase, lowercase, numbers, and special characters</small>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="confirm-password">Confirm New Password</label>
                                    <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm New Password">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn primary">Update Password</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Online Grocery Store. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            fetch('../php/delivery/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'delivery') {
                        window.location.href = '../login.html';
                    } else {
                        // Set user information in sidebar
                        document.getElementById('delivery-person-name').textContent = `Welcome, ${data.name}!`;
                        document.getElementById('delivery-person-email').textContent = data.email;
                        
                        // Load profile data
                        loadProfileData();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = '../login.html';
                });
        });
        
        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('sidebar-logout').addEventListener('click', logout);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    
                    // Add active class to current tab
                    this.classList.add('active');
                    document.getElementById(`${this.getAttribute('data-tab')}-tab`).classList.add('active');
                });
            });
            
            // Payment method switching
            document.getElementById('payment-method').addEventListener('change', function() {
                const method = this.value;
                
                // Hide all payment fields
                document.querySelectorAll('.bank-field, .paypal-field, .mobile-wallet-field').forEach(field => {
                    field.style.display = 'none';
                });
                
                // Show fields based on selected method
                if (method === 'bank_transfer') {
                    document.querySelectorAll('.bank-field').forEach(field => {
                        field.style.display = 'block';
                    });
                } else if (method === 'paypal') {
                    document.querySelectorAll('.paypal-field').forEach(field => {
                        field.style.display = 'block';
                    });
                } else if (method === 'mobile_wallet') {
                    document.querySelectorAll('.mobile-wallet-field').forEach(field => {
                        field.style.display = 'block';
                    });
                }
            });
            
            // Form submission handlers
            document.getElementById('personal-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePersonalInfo();
            });
            
            document.getElementById('vehicle-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveVehicleInfo();
            });
            
            document.getElementById('bank-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveBankInfo();
            });
            
            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });
        }
        
        function logout(e) {
            e.preventDefault();
            fetch('../php/logout.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '../login.html';
                    }
                })
                .catch(error => console.error('Error logging out:', error));
        }
        
        function loadProfileData() {
            // Load personal info
            fetch('../php/delivery/get_profile.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading profile:', data.error);
                        return;
                    }
                    
                    // Set personal info
                    document.getElementById('first-name').value = data.first_name || '';
                    document.getElementById('last-name').value = data.last_name || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('city').value = data.city || '';
                    document.getElementById('postal-code').value = data.postal_code || '';
                    document.getElementById('dob').value = data.dob || '';
                    document.getElementById('id-number').value = data.id_number || '';
                    
                    // Set vehicle info if available
                    if (data.vehicle) {
                        document.getElementById('vehicle-type').value = data.vehicle.type || '';
                        document.getElementById('vehicle-make').value = data.vehicle.make || '';
                        document.getElementById('vehicle-model').value = data.vehicle.model || '';
                        document.getElementById('vehicle-year').value = data.vehicle.year || '';
                        document.getElementById('license-plate').value = data.vehicle.license_plate || '';
                        document.getElementById('vehicle-color').value = data.vehicle.color || '';
                        document.getElementById('vehicle-notes').value = data.vehicle.notes || '';
                    }
                    
                    // Set payment info if available
                    if (data.payment) {
                        document.getElementById('payment-method').value = data.payment.method || '';
                        
                        // Trigger the change event to show/hide fields
                        const event = new Event('change');
                        document.getElementById('payment-method').dispatchEvent(event);
                        
                        if (data.payment.method === 'bank_transfer') {
                            document.getElementById('bank-name').value = data.payment.bank_name || '';
                            document.getElementById('account-name').value = data.payment.account_name || '';
                            document.getElementById('account-number').value = data.payment.account_number || '';
                            document.getElementById('routing-number').value = data.payment.routing_number || '';
                        } else if (data.payment.method === 'paypal') {
                            document.getElementById('paypal-email').value = data.payment.paypal_email || '';
                        } else if (data.payment.method === 'mobile_wallet') {
                            document.getElementById('wallet-type').value = data.payment.wallet_type || '';
                            document.getElementById('wallet-id').value = data.payment.wallet_id || '';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading profile data:', error);
                });
        }
        
        function savePersonalInfo() {
            const formData = {
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                postal_code: document.getElementById('postal-code').value,
                dob: document.getElementById('dob').value,
                id_number: document.getElementById('id-number').value
            };
            
            fetch('../php/delivery/update_profile.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'personal',
                    data: formData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating profile: ' + data.error);
                } else {
                    alert('Personal information updated successfully!');
                    // Update sidebar name if first or last name changed
                    if (formData.first_name || formData.last_name) {
                        const fullName = `${formData.first_name} ${formData.last_name}`.trim();
                        document.getElementById('delivery-person-name').textContent = `Welcome, ${fullName}!`;
                    }
                }
            })
            .catch(error => {
                console.error('Error updating personal info:', error);
                alert('An error occurred while updating your personal information. Please try again.');
            });
        }
        
        function saveVehicleInfo() {
            const formData = {
                type: document.getElementById('vehicle-type').value,
                make: document.getElementById('vehicle-make').value,
                model: document.getElementById('vehicle-model').value,
                year: document.getElementById('vehicle-year').value,
                license_plate: document.getElementById('license-plate').value,
                color: document.getElementById('vehicle-color').value,
                notes: document.getElementById('vehicle-notes').value
            };
            
            fetch('../php/delivery/update_profile.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'vehicle',
                    data: formData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating vehicle information: ' + data.error);
                } else {
                    alert('Vehicle information updated successfully!');
                }
            })
            .catch(error => {
                console.error('Error updating vehicle info:', error);
                alert('An error occurred while updating your vehicle information. Please try again.');
            });
        }
        
        function saveBankInfo() {
            const paymentMethod = document.getElementById('payment-method').value;
            let formData = {
                method: paymentMethod
            };
            
            // Add fields based on payment method
            if (paymentMethod === 'bank_transfer') {
                formData = {
                    ...formData,
                    bank_name: document.getElementById('bank-name').value,
                    account_name: document.getElementById('account-name').value,
                    account_number: document.getElementById('account-number').value,
                    routing_number: document.getElementById('routing-number').value
                };
            } else if (paymentMethod === 'paypal') {
                formData = {
                    ...formData,
                    paypal_email: document.getElementById('paypal-email').value
                };
            } else if (paymentMethod === 'mobile_wallet') {
                formData = {
                    ...formData,
                    wallet_type: document.getElementById('wallet-type').value,
                    wallet_id: document.getElementById('wallet-id').value
                };
            }
            
            fetch('../php/delivery/update_profile.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'payment',
                    data: formData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating payment information: ' + data.error);
                } else {
                    alert('Payment information updated successfully!');
                }
            })
            .catch(error => {
                console.error('Error updating payment info:', error);
                alert('An error occurred while updating your payment information. Please try again.');
            });
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validate passwords
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('All password fields are required.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New password and confirmation do not match.');
                return;
            }
            
            // Validate password strength
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                alert('Password must be at least 8 characters and include uppercase, lowercase, numbers, and special characters.');
                return;
            }
            
            fetch('../php/delivery/update_password.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error updating password: ' + data.error);
                } else {
                    alert('Password updated successfully!');
                    // Clear password fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                }
            })
            .catch(error => {
                console.error('Error updating password:', error);
                alert('An error occurred while updating your password. Please try again.');
            });
        }
    </script>
</body>
</html>
