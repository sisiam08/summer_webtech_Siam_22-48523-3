<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Management - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body class="admin">
    <div class="admin-sidebar">
        <div class="brand">
            Grocery Admin
        </div>
        <div class="menu">
            <a href="index.html" class="menu-item">
                <i class="material-icons">dashboard</i> Dashboard
            </a>
            <a href="products.html" class="menu-item active">
                <i class="material-icons">inventory</i> Products
            </a>
            <a href="categories.html" class="menu-item">
                <i class="material-icons">category</i> Categories
            </a>
            <a href="orders.html" class="menu-item">
                <i class="material-icons">shopping_cart</i> Orders
            </a>
            <a href="users.html" class="menu-item">
                <i class="material-icons">people</i> Users
            </a>
            <a href="vendors.html" class="menu-item">
                <i class="material-icons">store</i> Vendors
            </a>
            <a href="settings.html" class="menu-item">
                <i class="material-icons">settings</i> Settings
            </a>
        </div>
    </div>

    <div class="admin-content">
        <div class="admin-header">
            <h2>Products Management</h2>
            <div class="user-info">
                <div class="dropdown">
                    <span id="admin-username">Admin</span>
                    <i class="material-icons">arrow_drop_down</i>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="#" id="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="admin-card-header">
                <h3>Products List</h3>
                <button class="admin-btn admin-btn-primary" id="add-product-btn">
                    <i class="material-icons">add</i> Add New Product
                </button>
            </div>
            
            <div class="search-filters">
                <div class="search-box">
                    <input type="text" id="search-product" class="admin-form-control" placeholder="Search products...">
                </div>
                <div class="filter-box">
                    <select id="category-filter" class="admin-form-control">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                <div class="filter-box">
                    <select id="vendor-filter" class="admin-form-control">
                        <option value="">All Vendors</option>
                        <!-- Vendors will be loaded here -->
                    </select>
                </div>
            </div>
            
            <table class="admin-table" id="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Vendor</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
            
            <div class="pagination" id="products-pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Product</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="product-form" enctype="multipart/form-data">
                    <input type="hidden" id="product-id" name="id">
                    
                    <div class="admin-form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" name="name" class="admin-form-control" required>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" name="description" class="admin-form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="admin-form-row">
                        <div class="admin-form-group">
                            <label for="product-price">Price</label>
                            <input type="number" id="product-price" name="price" class="admin-form-control" step="0.01" min="0" required>
                        </div>
                        
                        <div class="admin-form-group">
                            <label for="product-stock">Stock</label>
                            <input type="number" id="product-stock" name="stock" class="admin-form-control" min="0" required>
                        </div>
                    </div>
                    
                    <div class="admin-form-row">
                        <div class="admin-form-group">
                            <label for="product-category">Category</label>
                            <select id="product-category" name="category_id" class="admin-form-control" required>
                                <option value="">Select Category</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        
                        <div class="admin-form-group">
                            <label for="product-vendor">Vendor</label>
                            <select id="product-vendor" name="vendor_id" class="admin-form-control" required>
                                <option value="">Select Vendor</option>
                                <!-- Vendors will be loaded here -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="product-image">Product Image</label>
                        <input type="file" id="product-image" name="image" class="admin-form-control">
                        <div id="current-image-container" style="display: none; margin-top: 10px;">
                            <p>Current Image:</p>
                            <img id="current-image" src="" alt="Current Product Image" style="max-width: 100px; max-height: 100px;">
                        </div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="product-status">Status</label>
                        <select id="product-status" name="status" class="admin-form-control" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-buttons">
                        <button type="button" class="admin-btn admin-btn-secondary" id="cancel-product">Cancel</button>
                        <button type="submit" class="admin-btn admin-btn-primary" id="save-product">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <div class="admin-form-buttons">
                    <button type="button" class="admin-btn admin-btn-secondary" id="cancel-delete">Cancel</button>
                    <button type="button" class="admin-btn admin-btn-danger" id="confirm-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Additional styles for modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            width: 70%;
            max-width: 700px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close-modal {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .admin-form-row {
            display: flex;
            gap: 15px;
        }
        
        .admin-form-row .admin-form-group {
            flex: 1;
        }
        
        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 2;
        }
        
        .filter-box {
            flex: 1;
        }
        
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .pagination button {
            margin: 0 5px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>

    <script>
        // Check if user is logged in and has admin privileges
        fetch('../php/check_admin.php')
            .then(response => response.json())
            .then(data => {
                if (!data.is_admin) {
                    // If not admin, redirect to login page
                    window.location.href = 'login.html';
                } else {
                    // Display admin username
                    document.getElementById('admin-username').textContent = data.name || 'Admin';
                    
                    // Load initial data
                    loadProducts();
                    loadCategories();
                    loadVendors();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.location.href = 'login.html';
            });
        
        // Variables for pagination
        let currentPage = 1;
        let totalPages = 1;
        let productsPerPage = 10;
        
        // Load products
        function loadProducts(page = 1, search = '', category = '', vendor = '') {
            fetch(`../php/admin/get_products.php?page=${page}&limit=${productsPerPage}&search=${search}&category=${category}&vendor=${vendor}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('products-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';
                    
                    if (data.products.length === 0) {
                        const row = tableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 9;
                        cell.textContent = 'No products found';
                        cell.style.textAlign = 'center';
                        return;
                    }
                    
                    // Update pagination variables
                    currentPage = data.current_page;
                    totalPages = data.total_pages;
                    
                    // Display products
                    data.products.forEach(product => {
                        const row = tableBody.insertRow();
                        
                        // ID column
                        const idCell = row.insertCell();
                        idCell.textContent = product.id;
                        
                        // Image column
                        const imageCell = row.insertCell();
                        const img = document.createElement('img');
                        img.src = product.image ? `../uploads/products/${product.image}` : '../images/no-image.png';
                        img.alt = product.name;
                        img.className = 'product-image';
                        imageCell.appendChild(img);
                        
                        // Name column
                        const nameCell = row.insertCell();
                        nameCell.textContent = product.name;
                        
                        // Category column
                        const categoryCell = row.insertCell();
                        categoryCell.textContent = product.category;
                        
                        // Vendor column
                        const vendorCell = row.insertCell();
                        vendorCell.textContent = product.vendor;
                        
                        // Price column
                        const priceCell = row.insertCell();
                        priceCell.textContent = '$' + parseFloat(product.price).toFixed(2);
                        
                        // Stock column
                        const stockCell = row.insertCell();
                        stockCell.textContent = product.stock;
                        
                        // Status column
                        const statusCell = row.insertCell();
                        const statusBadge = document.createElement('span');
                        statusBadge.className = `status-badge ${product.status}`;
                        statusBadge.textContent = product.status.charAt(0).toUpperCase() + product.status.slice(1);
                        statusCell.appendChild(statusBadge);
                        
                        // Actions column
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button class="admin-btn admin-btn-primary admin-btn-small edit-product" data-id="${product.id}">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="admin-btn admin-btn-danger admin-btn-small delete-product" data-id="${product.id}">
                                <i class="material-icons">delete</i>
                            </button>
                        `;
                    });
                    
                    // Update pagination
                    updatePagination();
                })
                .catch(error => console.error('Error loading products:', error));
        }
        
        // Load categories
        function loadCategories() {
            fetch('../php/admin/get_categories.php')
                .then(response => response.json())
                .then(data => {
                    // Populate category filter
                    const categoryFilter = document.getElementById('category-filter');
                    categoryFilter.innerHTML = '<option value="">All Categories</option>';
                    
                    // Populate category dropdown in form
                    const categoryDropdown = document.getElementById('product-category');
                    categoryDropdown.innerHTML = '<option value="">Select Category</option>';
                    
                    data.forEach(category => {
                        // Add to filter
                        const filterOption = document.createElement('option');
                        filterOption.value = category.id;
                        filterOption.textContent = category.name;
                        categoryFilter.appendChild(filterOption);
                        
                        // Add to form dropdown
                        const formOption = document.createElement('option');
                        formOption.value = category.id;
                        formOption.textContent = category.name;
                        categoryDropdown.appendChild(formOption);
                    });
                })
                .catch(error => console.error('Error loading categories:', error));
        }
        
        // Load vendors
        function loadVendors() {
            fetch('../php/admin/get_vendors.php')
                .then(response => response.json())
                .then(data => {
                    // Populate vendor filter
                    const vendorFilter = document.getElementById('vendor-filter');
                    vendorFilter.innerHTML = '<option value="">All Vendors</option>';
                    
                    // Populate vendor dropdown in form
                    const vendorDropdown = document.getElementById('product-vendor');
                    vendorDropdown.innerHTML = '<option value="">Select Vendor</option>';
                    
                    data.forEach(vendor => {
                        // Add to filter
                        const filterOption = document.createElement('option');
                        filterOption.value = vendor.id;
                        filterOption.textContent = vendor.name;
                        vendorFilter.appendChild(filterOption);
                        
                        // Add to form dropdown
                        const formOption = document.createElement('option');
                        formOption.value = vendor.id;
                        formOption.textContent = vendor.name;
                        vendorDropdown.appendChild(formOption);
                    });
                })
                .catch(error => console.error('Error loading vendors:', error));
        }
        
        // Update pagination controls
        function updatePagination() {
            const pagination = document.getElementById('products-pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    loadProducts(currentPage - 1, 
                        document.getElementById('search-product').value,
                        document.getElementById('category-filter').value,
                        document.getElementById('vendor-filter').value
                    );
                }
            });
            pagination.appendChild(prevButton);
            
            // Page buttons
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.addEventListener('click', () => {
                    loadProducts(i, 
                        document.getElementById('search-product').value,
                        document.getElementById('category-filter').value,
                        document.getElementById('vendor-filter').value
                    );
                });
                pagination.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    loadProducts(currentPage + 1, 
                        document.getElementById('search-product').value,
                        document.getElementById('category-filter').value,
                        document.getElementById('vendor-filter').value
                    );
                }
            });
            pagination.appendChild(nextButton);
        }
        
        // Search and filter handlers
        document.getElementById('search-product').addEventListener('input', debounce(function() {
            loadProducts(1, this.value, 
                document.getElementById('category-filter').value,
                document.getElementById('vendor-filter').value
            );
        }, 500));
        
        document.getElementById('category-filter').addEventListener('change', function() {
            loadProducts(1, 
                document.getElementById('search-product').value,
                this.value,
                document.getElementById('vendor-filter').value
            );
        });
        
        document.getElementById('vendor-filter').addEventListener('change', function() {
            loadProducts(1, 
                document.getElementById('search-product').value,
                document.getElementById('category-filter').value,
                this.value
            );
        });
        
        // Debounce function to prevent multiple rapid requests
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Modal functions
        const productModal = document.getElementById('product-modal');
        const deleteModal = document.getElementById('delete-modal');
        let currentProductId = null;
        
        // Open product modal for adding
        document.getElementById('add-product-btn').addEventListener('click', function() {
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('current-image-container').style.display = 'none';
            productModal.style.display = 'block';
        });
        
        // Handle edit product button clicks (delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-product')) {
                const button = e.target.closest('.edit-product');
                const productId = button.dataset.id;
                loadProductDetails(productId);
            }
        });
        
        // Load product details for editing
        function loadProductDetails(productId) {
            fetch(`../php/admin/get_product.php?id=${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('modal-title').textContent = 'Edit Product';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-description').value = product.description;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-stock').value = product.stock;
                    document.getElementById('product-category').value = product.category_id;
                    document.getElementById('product-vendor').value = product.vendor_id;
                    document.getElementById('product-status').value = product.status;
                    
                    // Display current image if exists
                    if (product.image) {
                        document.getElementById('current-image').src = `../uploads/products/${product.image}`;
                        document.getElementById('current-image-container').style.display = 'block';
                    } else {
                        document.getElementById('current-image-container').style.display = 'none';
                    }
                    
                    productModal.style.display = 'block';
                })
                .catch(error => console.error('Error loading product details:', error));
        }
        
        // Handle delete product button clicks (delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-product')) {
                const button = e.target.closest('.delete-product');
                currentProductId = button.dataset.id;
                deleteModal.style.display = 'block';
            }
        });
        
        // Submit product form
        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = document.getElementById('product-id').value;
            const url = productId ? '../php/admin/update_product.php' : '../php/admin/add_product.php';
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    productModal.style.display = 'none';
                    loadProducts(currentPage, 
                        document.getElementById('search-product').value,
                        document.getElementById('category-filter').value,
                        document.getElementById('vendor-filter').value
                    );
                    alert(data.message);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving product:', error);
                alert('An error occurred. Please try again.');
            });
        });
        
        // Confirm delete product
        document.getElementById('confirm-delete').addEventListener('click', function() {
            if (currentProductId) {
                fetch('../php/admin/delete_product.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: currentProductId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        deleteModal.style.display = 'none';
                        loadProducts(currentPage, 
                            document.getElementById('search-product').value,
                            document.getElementById('category-filter').value,
                            document.getElementById('vendor-filter').value
                        );
                        alert(data.message);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    alert('An error occurred. Please try again.');
                });
            }
        });
        
        // Cancel buttons and close modals
        document.getElementById('cancel-product').addEventListener('click', function() {
            productModal.style.display = 'none';
        });
        
        document.getElementById('cancel-delete').addEventListener('click', function() {
            deleteModal.style.display = 'none';
        });
        
        // Close modals when clicking on X button
        document.querySelectorAll('.close-modal').forEach(function(element) {
            element.addEventListener('click', function() {
                productModal.style.display = 'none';
                deleteModal.style.display = 'none';
            });
        });
        
        // Close modals when clicking outside the modal content
        window.addEventListener('click', function(e) {
            if (e.target === productModal) {
                productModal.style.display = 'none';
            }
            if (e.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
        
        // Handle logout
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            
            fetch('../php/logout.php')
                .then(response => response.json())
                .then(data => {
                    window.location.href = 'login.html';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>
</html>
