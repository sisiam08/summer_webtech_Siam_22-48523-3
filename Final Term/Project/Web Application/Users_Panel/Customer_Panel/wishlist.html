<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wishlist - Online Grocery Store</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/customer.css">
</head>
<body class="customer-dashboard">
    <header>
        <div class="container">
            <h1>Online Grocery Store</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="cart.html">Cart</a></li>
                    <li><a href="account.html" class="active">My Account</a></li>
                    <li><a href="#" id="logout-btn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container dashboard-container">
        <div class="dashboard-sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="material-icons">account_circle</i>
                </div>
                <div class="user-details">
                    <h3 id="customer-name">Welcome back!</h3>
                    <p id="customer-email">Loading...</p>
                </div>
            </div>
            <nav class="dashboard-nav">
                <ul>
                    <li>
                        <a href="account.html">
                            <i class="material-icons">dashboard</i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="orders.html">
                            <i class="material-icons">shopping_bag</i>
                            My Orders
                        </a>
                    </li>
                    <li>
                        <a href="addresses.html">
                            <i class="material-icons">location_on</i>
                            My Addresses
                        </a>
                    </li>
                    <li class="active">
                        <a href="wishlist.html">
                            <i class="material-icons">favorite</i>
                            Wishlist
                        </a>
                    </li>
                    <li>
                        <a href="profile.html">
                            <i class="material-icons">person</i>
                            Edit Profile
                        </a>
                    </li>
                    <li>
                        <a href="#" id="sidebar-logout">
                            <i class="material-icons">exit_to_app</i>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <div class="dashboard-content">
            <div class="content-header">
                <h2>My Wishlist</h2>
                <a href="products.html" class="btn primary">
                    <i class="material-icons">shopping_cart</i> Continue Shopping
                </a>
            </div>
            
            <div id="wishlist-container" class="wishlist-grid">
                <p class="loading">Loading your wishlist...</p>
                <!-- Wishlist items will be loaded dynamically -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Online Grocery Store. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            fetch('php/customer/check_auth.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.isAuthenticated || data.role !== 'customer') {
                        window.location.href = 'login.html';
                    } else {
                        // Set user information
                        document.getElementById('customer-name').textContent = `Welcome, ${data.name}!`;
                        document.getElementById('customer-email').textContent = data.email;
                        
                        // Load wishlist
                        loadWishlist();
                        
                        // Set up event listeners
                        setupEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    window.location.href = 'login.html';
                });
        });
        
        function setupEventListeners() {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('sidebar-logout').addEventListener('click', logout);
        }
        
        function logout(e) {
            e.preventDefault();
            fetch('php/logout.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = 'login.html';
                    }
                })
                .catch(error => console.error('Error logging out:', error));
        }
        
        function loadWishlist() {
            fetch('php/customer/get_wishlist.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading wishlist:', data.error);
                        document.getElementById('wishlist-container').innerHTML = `
                            <p class="empty-message">Error loading wishlist. Please try again.</p>
                        `;
                        return;
                    }
                    
                    renderWishlist(data.items);
                })
                .catch(error => {
                    console.error('Error loading wishlist:', error);
                    document.getElementById('wishlist-container').innerHTML = `
                        <p class="empty-message">Error loading wishlist. Please try again.</p>
                    `;
                });
        }
        
        function renderWishlist(items) {
            const wishlistContainer = document.getElementById('wishlist-container');
            
            if (items.length === 0) {
                wishlistContainer.innerHTML = `
                    <div class="empty-wishlist">
                        <i class="material-icons">favorite_border</i>
                        <p>Your wishlist is empty.</p>
                        <a href="products.html" class="btn primary">Discover Products</a>
                    </div>
                `;
                return;
            }
            
            let wishlistHtml = '';
            
            items.forEach(item => {
                // Calculate discount percentage if on sale
                let discountBadge = '';
                let priceHtml = '';
                
                if (item.sale_price && item.sale_price < item.price) {
                    const discountPercent = Math.round((1 - item.sale_price / item.price) * 100);
                    discountBadge = `<span class="discount-badge">-${discountPercent}%</span>`;
                    priceHtml = `
                        <div class="product-price">
                            <span class="current-price">$${parseFloat(item.sale_price).toFixed(2)}</span>
                            <span class="original-price">$${parseFloat(item.price).toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    priceHtml = `
                        <div class="product-price">
                            <span class="current-price">$${parseFloat(item.price).toFixed(2)}</span>
                        </div>
                    `;
                }
                
                // Check if product is in stock
                const stockStatus = item.stock > 0 
                    ? `<span class="in-stock">In Stock (${item.stock})</span>` 
                    : '<span class="out-of-stock">Out of Stock</span>';
                
                wishlistHtml += `
                    <div class="wishlist-item" data-id="${item.product_id}">
                        ${discountBadge}
                        <div class="wishlist-image">
                            <a href="product-details.html?id=${item.product_id}">
                                <img src="uploads/products/${item.image || 'no-image.jpg'}" alt="${item.name}">
                            </a>
                        </div>
                        <div class="wishlist-content">
                            <h3>
                                <a href="product-details.html?id=${item.product_id}">${item.name}</a>
                            </h3>
                            ${priceHtml}
                            <div class="product-stock">
                                ${stockStatus}
                            </div>
                            <div class="wishlist-actions">
                                <button class="btn primary add-to-cart-btn" data-id="${item.product_id}" 
                                        ${item.stock <= 0 ? 'disabled' : ''}>
                                    <i class="material-icons">shopping_cart</i> Add to Cart
                                </button>
                                <button class="btn icon danger remove-from-wishlist-btn" data-id="${item.product_id}">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            wishlistContainer.innerHTML = wishlistHtml;
            
            // Add event listeners to the wishlist items
            document.querySelectorAll('.add-to-cart-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    addToCart(productId);
                });
            });
            
            document.querySelectorAll('.remove-from-wishlist-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    removeFromWishlist(productId);
                });
            });
        }
        
        function addToCart(productId) {
            fetch('php/customer/add_to_cart.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error adding to cart: ' + data.error);
                } else {
                    // Show success message
                    alert('Product added to cart successfully!');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                alert('An error occurred while adding the product to cart. Please try again.');
            });
        }
        
        function removeFromWishlist(productId) {
            if (confirm('Are you sure you want to remove this item from your wishlist?')) {
                fetch('php/customer/remove_from_wishlist.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: productId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error removing from wishlist: ' + data.error);
                    } else {
                        // Reload wishlist
                        loadWishlist();
                    }
                })
                .catch(error => {
                    console.error('Error removing from wishlist:', error);
                    alert('An error occurred while removing the product from wishlist. Please try again.');
                });
            }
        }
    </script>
</body>
</html>
